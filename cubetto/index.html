<!doctype html>
<html class="lte-primary-1" lang="it">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Cubetto</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/base.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300,400" rel="stylesheet">
</head>

<body>
    
    <header class="header">
        <form>
            <button class="header__btt header__btt--settings" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                    <path d="M348 327.2v-35.75l-32.44-11.9c-2.82-10.92-6.61-21.22-12.21-30.7l.32-.04 15.44-32.15-25.2-25.27-32.12 15.3-.03.05c-9.47-5.6-19.76-9.16-30.67-11.98L219.2 162h-35.74l-11.92 32.76c-10.9 2.82-21.2 6.77-30.68 12.38l-.05-.25-32.15-15.4-25.27 25.22 15.3 32.12.05.04c-5.6 9.47-11.16 19.77-13.98 30.68L50 291.45v35.75l34.75 11.9c2.82 10.92 7.78 21.22 13.38 30.7l.25.04-15.15 32.15 25.35 25.27 32.19-15.3.06-.04c9.47 5.6 19.78 10.82 30.7 13.65L183.45 460h35.74l11.91-34.43c10.91-2.83 21.21-7.62 30.68-13.22l.05-.17 32.15 15.19 25.27-25.33-15.3-32.18-.04-.06c5.6-9.47 8.83-19.78 11.66-30.69L348 327.2zm-146.68 41.7a59.56 59.56 0 1 1 0-119.14 59.57 59.57 0 0 1 0 119.13z"/>
                    <path d="M462.24 111.24l-7.82-18.87-20.23 1.02a67.46 67.46 0 0 0-13.41-13.42l.03-.05 1.06-20.32-18.85-7.82-13.63 15.11-.01.03a67.43 67.43 0 0 0-19-.02l-13.62-15.13-18.87 7.82 1.06 20.32a67.26 67.26 0 0 0-13.4 13.46l-.04-.02-20.32-1.05-7.8 18.86 15.1 13.61.04.02c-.73 5.84-1.03 12.66-.13 19.04l-15.2 13.66 7.8 18.87 20.42-1.08a67.7 67.7 0 0 0 13.5 13.38v.03l-1.03 20.3 20.67 7.82 15.44-15.1v-.04c4 .73 10.82.94 17.2.04l12.72 15.11 18.42-7.8-1.28-20.33a67.11 67.11 0 0 0 13.3-13.46l-.03.01 20.29 1.05 7.8-18.86-15.12-13.63-.04-.02c.88-6.22.86-12.58-.05-18.95l15.03-13.59zm-69.33 54.5a34.03 34.03 0 1 1-26.04-62.88 34.03 34.03 0 0 1 26.04 62.88z"/>
                </svg>
            </button>

            <button class="header__btt header__btt--connect" type="button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 588 588">
                    <path d="M312.48 588.15a39.5 39.5 0 0 1-39.52-39.52V367.86l-150.5 100.12a39.51 39.51 0 1 1-43.77-65.8l162.77-108.32-162.8-107.9a39.53 39.53 0 0 1 43.8-65.81l150.5 100.14V39.53a39.5 39.5 0 0 1 58.18-34.85l154.54 82.77a78.91 78.91 0 0 1 41.35 65.46 78.88 78.88 0 0 1-34.9 69.1l-108.29 72.06L492.1 366.1a78.94 78.94 0 0 1 34.93 69.1 78.9 78.9 0 0 1-41.35 65.46l-154.54 82.8a39.37 39.37 0 0 1-18.66 4.7zM352 367.12v115.5l96.35-51.63L352 367.12zm0-261.93v115.13l96.33-64.1L352 105.2z"/>
                </svg>
            </button>
        </form>
    </header>


    <main class="main">

        <form class="main__board" action="#" method="post">
            <div class="main__algorithm">
                <ul>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                    <li class="main__step" data-context="main"></li>
                </ul>
                <button class="main__run" type="submit" 
                       disabled="disabled">Run</button>
                
            </div> 

            <div class="main__function">
              <ul>
                  <li class="main__step" data-context="function"></li>
                  <li class="main__step" data-context="function"></li>
                  <li class="main__step" data-context="function"></li>
                  <li class="main__step" data-context="function"></li>
               </ul>
            </div>
        </form>


        <aside class="list__pieces">
            
            <h3>
                <span lang="it">Istruzioni base</span>
                <span lang="en">Basic instructions</span>
            </h3>
            <ul class="main__pieces">
                <li class="main__piece">
                    <div class="main__piece--forward" draggable="true" data-statement="forward"></div></li>
                <li class="main__piece">
                    <div class="main__piece--left" draggable="true" data-statement="left"></div></li>
                <li class="main__piece">
                    <div class="main__piece--right" draggable="true" data-statement="right"></div></li>
                <li class="main__piece">
                    <div class="main__piece--function" draggable="true" data-statement="function"></div></li>
           </ul>

            <h3>
                <span lang="it">Istruzioni speciali</span>
                <span lang="en">Special instructions</span>
            </h3>
            <ul class="special__pieces">
                <li class="special__piece">
                    <div class="special__piece--reverse" draggable="false" data-statement="reverse"></div></li>
                <li class="special__piece">
                    <div class="special__piece--180turn" draggable="false" data-statement="180turn"></div></li>
           </ul>

                
    
        </aside>

    </main>

    <section class="dialogs">

        <div class="dialog dialog--dlg-no-ble-connection">            
            <div class="dialog__wrap">
                <h2>
                    <span lang="it">Oh-Oh! <br/>Non trovo cubetto</span>
                    <span lang="en">Uh-Oh! <br/>I can't find cubetto</span>
                </h2>
            </div>
            <form class="dialog__menu" action="#">
                <button class="dialog__btt dialog__btt--connect" type="button">
                    <span lang="it">Cerca</span>
                    <span lang="en">Find</span>
                </button>
                <button class="dialog__btt dialog__btt--close" type="button">
                    <span lang="it">Chiudi</span>
                    <span lang="en">Close</span>
                </button>
            </form>
        </div>

        <div class="dialog dialog--dlg-settings">            
            <div class="dialog__wrap">
                <h2>
                    <span lang="it">Impostazioni</span>
                    <span lang="en">Settings</span>
                </h2>
                <form >
                    <fieldset>                        
                        <input type="text" id="stt_devicename" placeholder="FC-883F" autocomplete="off" />
                        <label for="stt_devicename">
                            <span lang="it">Nome device</span>
                            <span lang="en">Device name</span>
                        </label>
                    </fieldset>
                    <fieldset>
                        <input type="radio" id="stt_basicstmt" name="extrastmt" value="0" checked="checked" />
                        <label for="stt_basicstmt">
                            <span lang="it">Istruzioni base<br /><small>
                            Abilita movimento in avanti, rotazione destra/sinistra con 11 istruzioni principali e 4 istruzioni funzione.</small></span>
                            <span lang="en">Basic instructions <br /><small>
                            Enables forward move, right/left rotation with 11 main instructions and 4 function instructions.</small></span>
                        </label>

                        <input type="radio" id="stt_reverse" name="extrastmt" value="1" />
                        <label for="stt_reverse">
                            <span lang="it">Istruzioni base + retromarcia <br /><small>
                            Aggiunge una singola istruzione di retromarcia di una casella ma sono disponibili solo 3 istruzioni funzione e 10 istruzioni base.</small></span>
                            <span lang="en">Basic instructions + reverse gear <br /><small>
                            Adds a one-time reverse gear instruction for a single case but only 3 function instructions and 10 main instructions are available.</small></span>
                        </label>
                    
                        <input type="radio" id="stt_180turn" name="extrastmt" value="2" />
                        <label for="stt_180turn">
                            <span lang="it">Istruzioni base + rotazione 180° <br /><small>
                            Aggunge una singola rotazione di 180 gradi ma sono disponibili solo 9 istruzioni principali.</small></span>
                            <span lang="en">Basic instructions + 180° rotation <br /><small>
                            Adds a one-time 180° rotation instruction but only 9 main statements are available.</small></span>
                        </label>
                    </fieldset>
                <form>
            </div>
            <menu class="dialog__menu">
                
                <button class="dialog__btt dialog__btt--close" type="button">
                    <span lang="it">Chiudi</span>
                    <span lang="en">Close</span>
                </button>
            </menu>
        </div>
        
    </section>


    <script>
        let steps    = document.querySelectorAll('.main__step');
        let pieces   = document.querySelector('.list__pieces');  
        let board    = document.querySelector('.main__board');
        let conn     = document.querySelector('.main__connect');
        let mainList = document.querySelector('.main__algorithm ul');
        let funcList = document.querySelector('.main__function ul');
        let runBtt   = document.querySelector('.main__run');
        let sttBtt   = document.querySelector('.header__btt--settings');
        let connBtt  = document.querySelector('.header__btt--connect');
        let body     = document.body;

        let currentMode = 0;

        let algorithm = []
        let currentStmt;




        const BLE = {
            name            : document.getElementById('stt_devicename').value || 'FC-883F',
            service         : 0xffe0,
            characteristic  : 0xffe1
        };

        let BLECharacteristic;

        function getStatementArray(stmtNodes) {
            return [...stmtNodes].map((s) => {
                return {
                    step: s,
                    data: {
                        'forward'  : 1,
                        'left'     : 2,
                        'right'    : 3,
                        'function' : 4,
                        '180turn'  : 5,
                        'reverse'  : 6
                    }[s.dataset.statement]
                }
            })
        };


        function getAlgorithm(msa, mfa) {
            
            let _algorithm = [];

            msa.forEach((s) => {
                if (s.data === 4) {
                    mfa.forEach((_) => {
                        _algorithm.push({
                            step: [s.step, _.step],
                            data: _.data + 10
                        })
                    });
                }
                else {
                    _algorithm.push({
                        data: s.data,
                        step: [s.step]
                    });
                }
            });

            return _algorithm;
        }


        function unBlinkStmt() {
            let blinkingStmt = board.querySelectorAll('.blink');
            [...blinkingStmt].forEach((bs) => {
                bs.classList.remove('blink'); 
            });
            
        }

        function blinkStmt(stmt) {
            setTimeout(() => {
                stmt.step.forEach((bs) => bs.classList.add('blink'));
            }, 20);
        }

        function BLEConnection() {

            BLECharacteristic = null;
            return navigator.bluetooth.requestDevice({
                filters: [
                    { name: BLE.name },
                    { services: [ BLE.service ] }
                ] 
            })
            .then(device  => {
                mainRobot = device;
                return device.gatt.connect();
            })
            .then(server  =>  
                server.getPrimaryService(BLE.service))
            .then(service => 
                service.getCharacteristic(BLE.characteristic))
            .then(characteristic => {
                return characteristic;  
            })
            .catch(error => {
                alert(error);
            });
        };


        function getBLEValue(event) {
            var value = event.target.value.getUint8(0);
            console.log("Value changed", value);

            if (value === 255) {
                console.log('idle');
                unBlinkStmt();
                console.table(algorithm);

                if (algorithm.length > 0) {
                    currentStmt = algorithm.shift();
                    blinkStmt(currentStmt);
                    console.info("Executing", currentStmt.data);
                    BLECharacteristic.writeValue(Uint8Array.of(currentStmt.data));
                }
            
            }
        };


        function initBLEConnection() {
            BLEConnection().then(c => {
                BLECharacteristic = c;
                return BLECharacteristic.startNotifications().then(_ => {
                    console.log('[startnotifications]');      
                    BLECharacteristic.addEventListener('characteristicvaluechanged', getBLEValue);  
                });
            });
        };


        /* Bluetooth connection handler */
        connBtt.addEventListener('click', function(ev) {
            initBLEConnection();
        });


        /* submit form */
        board.addEventListener('submit', function(ev) {
            ev.preventDefault();

            if (BLECharacteristic === undefined) {
                body.classList.add('dlg-no-ble-connection');
                return false;   
            }


            let mainStmt = document.querySelectorAll('.main__algorithm [data-statement]');
            let funcStmt = document.querySelectorAll('.main__function [data-statement]');

            let mainStmtArray = getStatementArray(mainStmt);
            let mainFuncArray = getStatementArray(funcStmt);

            algorithm = getAlgorithm(mainStmtArray, mainFuncArray);


            console.table(algorithm);

            if (algorithm.length) {
                currentStmt = algorithm.shift();
                console.info("Executing", currentStmt.data);
                blinkStmt(currentStmt);
                BLECharacteristic.writeValue(Uint8Array.of(currentStmt.data));
            }
            
        });
        

        /* drag and drop pieces */

        var dragHandler = function(ev, dragEvent) {
            if (ev.target.matches('[draggable="true"]')) {
                ev.stopPropagation();
                return dragEvent(ev);
            }
        }

        var dragStart = function(ev) {
            let stmt = ev.target.dataset.statement;
            ev.dataTransfer.dropEffect = "copy";
            ev.dataTransfer.setData("text/plain", stmt);
        }

        
        pieces.addEventListener('dragstart', function(ev) {
            dragHandler(ev, dragStart);
        });


        board.addEventListener('dragover', function(ev) { 
            if (ev.target.matches('.main__step')) {
                ev.preventDefault(); 
            }
        });

        board.addEventListener('drop', function(ev) {

            let tgt = ev.target;
            if (tgt.matches('.main__step')) {
                ev.preventDefault();

                let mainStmt = document.querySelectorAll('.main__algorithm [data-statement]');
                let funcStmt = document.querySelectorAll('.main__function [data-statement]');
                let stmt = ev.dataTransfer.getData("text/plain");

                let prevEl = tgt.previousElementSibling;

                /* if the statement is 'function' and the target element is
                 * a step inside the function flow then we need to forbid this 
                 * action because it lead to an infinite recursion 
                 * Also we can't choose a function until the body of the function is empty
                 */
                if (stmt === 'function') {
                    if (tgt.closest('.main__function') || funcStmt.length === 0) {
                        return;
                    }
                }


                /* allow only adjacent drop */
                if (!!prevEl) {
                    if (!prevEl.matches('[data-statement]')) {
                        return;
                    }
                }

                tgt.dataset.statement = stmt;

                /* enable RUN button */
                mainStmt = document.querySelectorAll('.main__algorithm [data-statement]');
                if (mainStmt.length) {
                    runBtt.removeAttribute('disabled');
                }
                console.log(!!document.querySelector('.main__board [data-statement="reverse"]'));

                /* disable special instructions after single usage */
                if (!!document.querySelector('.main__board [data-statement="reverse"]')) {
                    
                    document.querySelector('.list__pieces [data-statement="reverse"]').setAttribute('draggable', false);
                }                
                if (!!document.querySelector('.main__board [data-statement="180turn"]')) {
                    document.querySelector('.list__pieces [data-statement="180turn"]').setAttribute('draggable', false);
                } 

            }            
        });


        var removeStatement = function(step, context) {

            let node = (context  === 'main')? mainList : funcList;
            let stmt = document.createElement('li');

            stmt.className = 'main__step';
            stmt.dataset.context = context;

            step.remove();
            node.appendChild(stmt);
        }


        board.addEventListener('dblclick', function(ev) { 
            let funcStmts, funcCalls, mainStmt;
            let tgt = ev.target;

            if (tgt.matches('.main__step[data-statement]')) {
                
                removeStatement(tgt, tgt.dataset.context);
                funcCalls = document.querySelectorAll('.main__algorithm [data-statement="function"]');
                funcStmts = document.querySelectorAll('.main__function [data-statement]');
                

                if (funcStmts.length === 0 && funcCalls.length > 0) {
                    [...funcCalls].forEach((funcCall) => {
                        removeStatement(funcCall, 'main');
                    });
                }


                /* enable special instructions after single usage */
                if (!document.querySelector('.main__board [data-statement="reverse"]') && body.classList.contains('stt_reverse')) {
                    
                    document.querySelector('.list__pieces [data-statement="reverse"]').setAttribute('draggable', true);
                }                
                if (!document.querySelector('.main__board [data-statement="180turn"]') && body.classList.contains('stt_turn180')) {
                    document.querySelector('.list__pieces [data-statement="180turn"]').setAttribute('draggable', true);
                }                 

                /* disable RUN button */
                mainStmt  = document.querySelectorAll('.main__algorithm [data-statement]');
                if (mainStmt.length === 0) {
                    runBtt.setAttribute('disabled', 'disabled');
                }

            }

        });


        /*** Modals ***/
        function closeDialog() {

            let stt_reverse = document.getElementById('stt_reverse');
            let stt_turn180 = document.getElementById('stt_180turn');
            let selectedMode = 0;
            
            let reverse = document.querySelector('.special__piece--reverse');
            let turn180 = document.querySelector('.special__piece--180turn');

            /* close dialogs */
            body.classList.remove('dlg-settings');
            body.classList.remove('dlg-no-ble-connection');

            /* check for stmt settings */
            reverse.setAttribute('draggable', stt_reverse.checked);
            turn180.setAttribute('draggable', stt_turn180.checked);

            if (stt_reverse.checked) {
                body.classList.add('stt_reverse');
                selectedMode = 1;
            }
            else {
                body.classList.remove('stt_reverse');

            }

            if (stt_turn180.checked) {
                body.classList.add('stt_turn180');
                selectedMode = 2;
            }
            else {
                body.classList.remove('stt_turn180');
            }

            if (selectedMode !== currentMode) {
                /* reset board */
                [...steps].forEach((s) => {
                    s.removeAttribute('data-statement');
                });
                currentMode = selectedMode;
            }
        }

        sttBtt.addEventListener('click', function() {
            body.classList.add('dlg-settings');
        });


        body.addEventListener('click', function(ev) {
            let tgt = ev.target;

            if (tgt.matches('.dialog__btt--close')) {
                closeDialog();
            }

            if (tgt.matches('.dialog__btt--connect > *')) {
                initBLEConnection();
            }

        });
    </script>



</body>
</html>

<!doctype html>
<html class="no-js" lang="">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/base.min.css">
</head>

<body>
    
    <section class="intro">
        <button id="cubetto__connect">Connetti</button>
    </section>
     
    <section class="cubetto">

        <form class="cubetto__board" action="" method="post">

            <div class="cubetto__algorithm">
                <ul>
                    <li class="cubetto__step">1</li>
                    <li class="cubetto__step">2</li>
                    <li class="cubetto__step">3</li>
                    <li class="cubetto__step">4</li>
                    <li class="cubetto__step">5</li>
                    <li class="cubetto__step">6</li>
                    <li class="cubetto__step">7</li>
                    <li class="cubetto__step">8</li>
                    <li class="cubetto__step">9</li>
                    <li class="cubetto__step">10</li>
                    <li class="cubetto__step">11</li>
               </ul>
               <button class="cubetto__playbtt" type="submit">Run</button>
            </div> 

            <div class="cubetto__function">
              <ul>
                  <li class="cubetto__step">1</li>
                  <li class="cubetto__step">2</li>
                  <li class="cubetto__step">3</li>
                  <li class="cubetto__step">4</li>
               </ul>
            </div>
        </form>


        <aside class="cubetto__pieces">
          
            <ul>
              <li class="cubetto__piece">
                <div class="cubetto__piece--forward" draggable="true" data-statement="forward">
                    
                </div></li>
              <li class="cubetto__piece">
                <div class="cubetto__piece--left" draggable="true" data-statement="left">
                    
                </div></li>
              <li class="cubetto__piece">
                <div class="cubetto__piece--right" draggable="true" data-statement="right">
                    
                </div></li>
              <li class="cubetto__piece">
                <div class="cubetto__piece--function" draggable="true" data-statement="function">
                    
                </div></li>
            </ul>

        <aside>

    </section>


    <script>
        let pieces = document.querySelector('.cubetto__pieces');
        let steps  = document.querySelectorAll('.cubetto__step');
        let board  = document.querySelector('.cubetto__board');
        let conn   = document.getElementById('cubetto__connect');


        const BLE = {
            name            : 'FC-A184',
            service         : 0xFFE0,
            characteristic  : 0xFFE1
        };

        let moveChar;


        function BLEConnection() {

            moveChar = null;
            return navigator.bluetooth.requestDevice({
                filters: [
                    { name: BLE.name },
                    { services: [ BLE.service ] }
                ] 
            })
            .then(device  => {
                cubettoRobot = device;
                return device.gatt.connect();
            })
            .then(server  =>  
                server.getPrimaryService(BLE.service))
            .then(service => 
                service.getCharacteristic(BLE.characteristic))
            .then(characteristic => {
                return characteristic;  
            })
            .catch(error => {
                alert(error);
            });
        }


        /* Bluetooth connection handler */
        conn.addEventListener('click', function(ev) {

            BLEConnection().then(c => {
                moveChar = c;
                moveChar.addEventListener('characteristicvaluechanged', function(event) {
                    var value = event.target.value.getUint8(0);
                    console.log('[characteristicvaluechanged]:', value);
                });

                // moveChar.readValue().then(function(v) {
                //     console.log("Reading value:", v);
                //     console.log("writing value: 2");
                //     moveChar.writeValue(Uint8Array.of(2));
                // });

                moveChar.startNotifications().then(_ => {
                    console.log('[startnotifications]');

                    // setTimeout(function() {
                    //     moveChar.writeValue(Uint8Array.of(2));
                    // }, 5000)
                });

                console.log('[characteristic]:', moveChar)
                

            })
        });


        /* submit form */
        board.addEventListener('submit', function(ev) {
            ev.preventDefault();
            /*navigator.bluetooth.requestDevice({
                filters: [
                    { name: BLE.name },
                    { services: [ BLE.service ] }
                ]
            })
            .then(device  => { return device.gatt.connect(); })
            .then(server  => server.getPrimaryService(BLE.service))
            .then(service => service.getCharacteristic(BLE.characteristic))

            .then(char => {
                char.addEventListener('characteristicvaluechanged', function(event) {
                    var value = event.target.value.getUint8();
                    console.log('Received ' + value);
                });
                char.readValue()
                .then(function(v) {
                    console.log(v);
                    char.writeValue(Uint8Array.of(6)).then(function() {
                        char.readValue().then((v) => console.log(v));
                    })
                }) 
                console.log(c);

                                  
            })
            .catch(error => {
                console.error(error);
            });*/
        });
        

        /* drag and drop pieces */



        var dragHandler = function(ev, dragEvent) {
            if (ev.target.matches('[draggable]')) {
                ev.stopPropagation();
                return dragEvent(ev);
            }
        }

        function dragStart(ev) {
            let stmt = ev.target.dataset.statement;
            ev.dataTransfer.dropEffect = "copy";
            ev.dataTransfer.setData("text/plain", stmt);
            console.log('dragstart', stmt)
        }

        
        pieces.addEventListener('dragstart', function(ev) {
            dragHandler(ev, dragStart);
        });

        
        [...steps].forEach(function(s) {

            s.addEventListener('dragover', function(ev) { ev.preventDefault(); });

            s.addEventListener('drop', function(ev) {
                ev.preventDefault();
                let stmt = ev.dataTransfer.getData("text/plain");

                /* if the statement is 'function' and the target element is
                 * a step inside the function flow then we need to forbid this 
                 * action because it lead to an infinite recursion 
                 */
                if (stmt === 'function' && this.closest('.cubetto__function')) {
                    return;
                }

                this.dataset.statement = stmt;
                console.log('drop', stmt);                
            });

            s.addEventListener('dblclick', function(ev) { 
                this.removeAttribute('data-statement');
            });

        });

        
    </script>



    <script>
        //https://raw.githubusercontent.com/binjospookie/web-bluetooth-api/master/index.js
        // mac: 00:15:87:10:A1:84
        
        /*
        const MY_BLUETOOTH_NAME = 'FC-A184';
        const send_service = 0xFFE0;
        const send_service_characteristic = 0xFFE1;

        const controlButtonsListElements = document.querySelectorAll('.control-buttons > li');
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const lightOffButton = document.getElementById('lightOff');
        const toggleRedLightButton = document.getElementById('toggleRedLight');
        const toggleBlueLightButton = document.getElementById('toggleBlueLight');
        const toggleGreenLightButton = document.getElementById('toggleGreenLight');
        const runBlinkLightButton = document.getElementById('runBlinkLight');

        let toggleLigthCharacteristic;
        let myDevice;

        connectButton.addEventListener('pointerup', connectButtonPointerUpHandler);

        function connectButtonPointerUpHandler() {
          navigator.bluetooth.requestDevice({
            filters:
              [
                { name: MY_BLUETOOTH_NAME },
                { services: [send_service] },
              ]
          })
            .then(device => {
              myDevice = device;

              return device.gatt.connect();
            })
            .then(server => server.getPrimaryService(send_service))
            .then(service => service.getCharacteristic(send_service_characteristic))
            .then(characteristic => {
              console.log(characteristic);
              // toggleLigthCharacteristic = characteristic;

              // toggleButtonsVisible();
              // toggleItemsEventListeners('addEventListener');
            })
            .catch(error => {
              console.error(error);
            });
        }*/

        // function lightOffButtonClickHandler() {
        //   return toggleLigthCharacteristic.writeValue(Uint8Array.of(0));
        // }

        // function toggleLightButtonClickHandler(event) {
        //   const code = Number(event.target.dataset.code);

        //   if (code === 1) {
        //     toggleLigthCharacteristic.writeValue(Uint8Array.of(code));

        //     return;
        //   }

        //   toggleLigthCharacteristic.readValue()
        //     .then(currentCode => {
        //       const convertedCode = currentCode.getUint8(0);

        //       toggleLigthCharacteristic.writeValue(Uint8Array.of(convertedCode === code ? 0 : code));
        //     });
        // }

        // function toggleButtonsVisible() {
        //   Array.prototype.forEach.call(controlButtonsListElements, listElement => {
        //     listElement.classList.toggle('visible');
        //   });
        // }

        // function disconnectButtonClickHandler() {
        //   lightOffButtonClickHandler()
        //     .then( () => {
        //       myDevice.gatt.disconnect();

        //       toggleItemsEventListeners('removeEventListener');
        //       toggleButtonsVisible();

        //       toggleLigthCharacteristic = undefined;
        //       myDevice = undefined;
        //     });
        // }

        // function toggleItemsEventListeners(action) {
        //   disconnectButton[action]('click', disconnectButtonClickHandler);
        //   lightOffButton[action]('click', lightOffButtonClickHandler);
        //   runBlinkLightButton[action]('click', toggleLightButtonClickHandler);
        //   toggleGreenLightButton[action]('click', toggleLightButtonClickHandler);
        //   toggleRedLightButton[action]('click', toggleLightButtonClickHandler);
        //   toggleBlueLightButton[action]('click', toggleLightButtonClickHandler);
        // }
    </script>
  
</body>
</html>

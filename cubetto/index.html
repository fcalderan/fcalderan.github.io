<!doctype html>
<html class="lte-primary-1" lang="it">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Cubetto</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="manifest" href="site.webmanifest">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="css/base.min.css">
    <link href="https://fonts.googleapis.com/css?family=Comfortaa:300,400" rel="stylesheet">
</head>

<body>
    
    <header class="intro">
        <button id="intro__connect">
            <span lang="it">Connetti</span>
            <span lang="en">Connect</span>
        </button>
    </header>


    <main class="main">

        <form class="main__board" action="#" method="post">

            <div class="main__algorithm">
                <ul>
                    <li class="main__step">1</li>
                    <li class="main__step">2</li>
                    <li class="main__step">3</li>
                    <li class="main__step">4</li>
                    <li class="main__step">5</li>
                    <li class="main__step">6</li>
                    <li class="main__step">7</li>
                    <li class="main__step">8</li>
                    <li class="main__step">9</li>
                    <li class="main__step">10</li>
                    <li class="main__step">11</li>
               </ul>
               <button class="main__playbtt" type="submit">Run</button>
            </div> 

            <div class="main__function">
              <ul>
                  <li class="main__step">1</li>
                  <li class="main__step">2</li>
                  <li class="main__step">3</li>
                  <li class="main__step">4</li>
               </ul>
            </div>
        </form>


        <aside class="main__pieces">
          
            <ul>
              <li class="main__piece">
                <div class="main__piece--forward" draggable="true" data-statement="forward">
                    
                </div></li>
              <li class="main__piece">
                <div class="main__piece--left" draggable="true" data-statement="left">
                    
                </div></li>
              <li class="main__piece">
                <div class="main__piece--right" draggable="true" data-statement="right">
                    
                </div></li>
              <li class="main__piece">
                <div class="main__piece--function" draggable="true" data-statement="function">
                    
                </div></li>
            </ul>
        </aside>

    </main>

    <section class="dialogs">

        <div class="dialog dialog--no-ble-connection">            
            <div class="dialog__wrap">
                <h2>
                    <span lang="it">Oh-Oh! <br/>Non trovo cubetto</span>
                    <span lang="en">Uh-Oh! <br/>I can't find cubetto</span>
                </h2>
            </div>
            <form class="dialog__menu" action="#">
                <button class="dialog__btt dialog__btt--connect" type="button">
                    <span lang="it">Cerca</span>
                    <span lang="en">Find</span>
                </button>
                <button class="dialog__btt dialog__btt--close" type="button">
                    <span lang="it">Chiudi</span>
                    <span lang="en">Close</span>
                </button>
            </form>
        </div>

        <!-- <dialog class="dialog dialog--no-algorithm">            
            <div class="dialog__wrap">
                <h2>
                    <span lang="it">Oh-Oh! <br/>Non trovo cubetto</span>
                    <span lang="en">Uh-Oh! <br/>I can't find cubetto</span>
                </h2>
            </div>
            <menu class="dialog__menu">
                
                <button class="dialog__btt dialog__btt--close">
                    <span lang="it">Chiudi</span>
                    <span lang="en">Close</span>
                </button>
            </menu>
        </dialog> -->
        
    </section>


    <script>
        let pieces = document.querySelector('.main__pieces');
        let steps  = document.querySelectorAll('.main__step');
        let board  = document.querySelector('.main__board');
        let conn   = document.getElementById('intro__connect');
        let mainList = document.querySelector('.main__algorithm ul');
        let body   = document.body;

        let algorithm = []
        let currentStmt;




        const BLE = {
            name            : 'FC-883F',
            service         : 0xffe0,
            characteristic  : 0xffe1
        };

        let BLECharacteristic;

        function getStatementArray(stmtNodes) {
            return [...stmtNodes].map((s) => {
                return {
                    step: s,
                    data: {
                        'forward'  : 1,
                        'left'     : 2,
                        'right'    : 3,
                        'function' : 4
                    }[s.dataset.statement]
                }
            })
        };


        function getAlgorithm(msa, mfa) {
            
            let _algorithm = [];

            msa.forEach((s) => {
                if (s.data === 4) {
                    mfa.forEach((_) => {
                        _algorithm.push({
                            step: [s.step, _.step],
                            data: _.data
                        })
                    });
                }
                else {
                    _algorithm.push({
                        data: s.data,
                        step: [s.step]
                    });
                }
            });

            return _algorithm;
        }


        function unBlinkStmt() {
            let blinkingStmt = board.querySelectorAll('.blink');
            [...blinkingStmt].forEach((bs) => {
                bs.classList.remove('blink'); 
            });
            
        }

        function blinkStmt(stmt) {
            setTimeout(() => {
                stmt.step.forEach((bs) => bs.classList.add('blink'));
            }, 20);
        }

        function BLEConnection() {

            BLECharacteristic = null;
            return navigator.bluetooth.requestDevice({
                filters: [
                    { name: BLE.name },
                    { services: [ BLE.service ] }
                ] 
            })
            .then(device  => {
                mainRobot = device;
                return device.gatt.connect();
            })
            .then(server  =>  
                server.getPrimaryService(BLE.service))
            .then(service => 
                service.getCharacteristic(BLE.characteristic))
            .then(characteristic => {
                return characteristic;  
            })
            .catch(error => {
                alert(error);
            });
        };


        function getBLEValue(event) {
            var value = event.target.value.getUint8(0);
            console.log("Value changed", value);

            if (value === 255) {
                console.log('idle');
                unBlinkStmt();
                console.table(algorithm);

                if (algorithm.length > 0) {
                    currentStmt = algorithm.shift();
                    blinkStmt(currentStmt);
                    console.info("Executing", currentStmt.data);
                    BLECharacteristic.writeValue(Uint8Array.of(currentStmt.data));
                }
            
            }
        };


        function initBLEConnection() {
            BLEConnection().then(c => {
                BLECharacteristic = c;
                return BLECharacteristic.startNotifications().then(_ => {
                    console.log('[startnotifications]');      
                    BLECharacteristic.addEventListener('characteristicvaluechanged', getBLEValue);  
                });
            });
        };


        /* Bluetooth connection handler */
        conn.addEventListener('click', function(ev) {
            initBLEConnection();
        });


        /* submit form */
        board.addEventListener('submit', function(ev) {
            ev.preventDefault();

            let mainStmt = document.querySelectorAll('.main__algorithm [data-statement]');
            let funcStmt = document.querySelectorAll('.main__function [data-statement]');

            let mainStmtArray = getStatementArray(mainStmt);
            let mainFuncArray = getStatementArray(funcStmt);

            algorithm = getAlgorithm(mainStmtArray, mainFuncArray);


            if (BLECharacteristic === undefined) {
                body.classList.add('no-ble-connection');
                return false;   
            }

            if (algorithm.length === 0) {
                body.classList.add('no-algorithm');
                return false;
            }

            console.table(algorithm);

            if (algorithm.length) {
                currentStmt = algorithm.shift();
                console.info("Executing", currentStmt.data);
                blinkStmt(currentStmt);
                BLECharacteristic.writeValue(Uint8Array.of(currentStmt.data));
            }
            
        });
        

        /* drag and drop pieces */



        var dragHandler = function(ev, dragEvent) {
            if (ev.target.matches('[draggable]')) {
                ev.stopPropagation();
                return dragEvent(ev);
            }
        }

        function dragStart(ev) {
            let stmt = ev.target.dataset.statement;
            ev.dataTransfer.dropEffect = "copy";
            ev.dataTransfer.setData("text/plain", stmt);
            //console.log('dragstart', stmt)
        }

        
        pieces.addEventListener('dragstart', function(ev) {
            dragHandler(ev, dragStart);
        });

        
        [...steps].forEach(function(s) {

            s.addEventListener('dragover', function(ev) { ev.preventDefault(); });

            s.addEventListener('drop', function(ev) {
                ev.preventDefault();

                let mainStmt = document.querySelectorAll('.main__algorithm [data-statement]');
                let funcStmt = document.querySelectorAll('.main__function [data-statement]');
                let stmt = ev.dataTransfer.getData("text/plain");

                let pES = this.previousElementSibling;

                /* if the statement is 'function' and the target element is
                 * a step inside the function flow then we need to forbid this 
                 * action because it lead to an infinite recursion 
                 * Also we can't choose a function until the body of the function is empty
                 */
                if (stmt === 'function') {
                    if (this.closest('.main__function') || funcStmt.length === 0) {
                        return;
                    }
                }

                /* allow only adjacent drop */
                if (!!pES) {
                    if (!pES.matches('[data-statement]')) {
                        return;
                    }
                }

                this.dataset.statement = stmt;
                //console.log('drop', stmt);                
            });


            s.addEventListener('dblclick', function(ev) { 
    
                let funcStmt, funcCall;
                let nES = this.nextElementSibling;
                if (nES === null || !nES.matches('[data-statement]')) {
                    this.removeAttribute('data-statement');
                }

                funcCall = document.querySelectorAll('.main__algorithm [data-statement="function"]');
                funcStmt = document.querySelectorAll('.main__function [data-statement]');

                if (funcStmt.length === 0 && funcCall.length > 0) {
                    [...funcCall].forEach((fc) => {
                        let step = document.createElement('li');
                        step.className = 'main__step';
                        mainList.appendChild(step);
                        fc.remove();
                    });
                }
            });
        });


        /*** Modals ***/
        function closeDialog() {
            body.className = "";
        }


        body.addEventListener('click', function(ev) {
            let tgt = ev.target;

            if (tgt.matches('.dialog__btt--close')) {
                closeDialog();
            }

            if (tgt.matches('.dialog__btt--connect > *')) {
                initBLEConnection();
            }

        });
    </script>



</body>
</html>
